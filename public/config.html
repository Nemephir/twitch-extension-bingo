<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Configuration Page </title>
    <link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
<div class="extension" id="app">
    <div class="settings">
        <label>
            Grid Size <input type="number" id="sizeSetting" min="1" max="5"/>
        </label>
<!--        <label>-->
<!--            <input type="checkbox" id="moderatorSetting"/>-->
<!--            Moderators can check-->
<!--        </label>-->
        <button type="button" id="saveButton">Save</button>
    </div>
    <div class="grid" id="grid"></div>
</div>


<script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
<script src="./src/Grid.js"></script>
<script src="https://bingo.twitch.nemephir.com/socket.io/socket.io.js"></script>
<script type="text/javascript">
	const socket = io()
	const twitch = window.Twitch.ext

	let formInited = false
	let channelId  = undefined
	let userId     = undefined

	window.onload = () => {
		socket.on( 'grid', initGrid )
		twitch.onContext( initTwitchContext )
		twitch.onAuthorized( initTwitchAuthorized )
	}

	const initTwitchContext = ( context ) => {
		// console.log( context )
	}

	const initTwitchAuthorized = ( auth ) => {
		channelId = auth.channelId
		userId    = auth.userId
		socket.emit( 'grid.load', channelId )
	}

	const initGrid = ( gridData ) => {
		let grid = new Grid( true )
			.setId( gridData._id )
			.setChannel( gridData.channel )
			.setSize( gridData.size )
			.setModerator( gridData.moderator )
			.setCells( gridData.cells )
			.render()

        if( !formInited ) {
            // Size Settings
            const sizeSettingEl = document.getElementById( 'sizeSetting' )
            sizeSettingEl.value = grid.size
            sizeSettingEl.addEventListener( 'input', () => {
                grid.setSize( Number( sizeSettingEl.value ) )
                    .render()
            } )

            // Moderator settings
            // const moderatorSettingEl   = document.getElementById( 'moderatorSetting' )
            // moderatorSettingEl.checked = grid.moderator
            // moderatorSettingEl.addEventListener( 'change', () => {
            //     grid.setModerator( moderatorSettingEl.checked )
            // } )

            // Save button
            const saveEl = document.getElementById( 'saveButton' )
            saveEl.addEventListener( 'click', () => {
                let data = {
                    _id      : grid.id,
                    channel  : gridData.channel,
                    size     : grid.size,
                    moderator: grid.moderator,
                    cells    : grid.cells
                }
                socket.emit( 'grid.save', data )
            } )

            formInited = true
	    }
	}

</script>
</body>

</html>